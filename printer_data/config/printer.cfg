[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.00122
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 15, 15
#    start point of bed mesh [X, Y]
mesh_max: 210, 200
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 10

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 225
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 120

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345 bed]           #### Uncomment for Y
cs_pin: rpi:None        #### Uncomment for Y

[resonance_tester]      #### Uncomment for Y
accel_chip: adxl345 bed #### Uncomment for Y
probe_points:           #### Uncomment for Y
    112, 112, 20        #### Uncomment for Y

[adxl345 toolhead]      #### Uncomment for X
cs_pin: scanner:PA3     #### Uncomment for X
spi_bus: spi1           #### Uncomment for X

[resonance_tester]      #### Uncomment for X
accel_chip: adxl345 toolhead   #### Uncomment for X
probe_points:           #### Uncomment for X
    112, 112, 20        #### Uncomment for X

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 6000
max_z_velocity: 30
max_z_accel: 400
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 250
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 54.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 42.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.061
#*# pid_ki = 2.751
#*# pid_kd = 71.555
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.238
#*# pid_ki = 0.838
#*# pid_kd = 1309.033
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.035
#*#
#*# [scanner model default]
#*# model_coef = 1.491232244621322,
#*# 	1.8512823599319221,
#*# 	0.759789169944979,
#*# 	0.10775960492840443,
#*# 	0.4654680403094783,
#*# 	1.2771829857066193,
#*# 	-0.5124204736358763,
#*# 	-1.6709161433537498,
#*# 	0.44458975589227545,
#*# 	0.8849733341967337
#*# model_domain = 3.160784958828788e-07,3.2922575083350163e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 26.326776
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.333744, 0.310174, 0.287074, 0.275375, 0.264297, 0.251977, 0.241040, 0.230554, 0.218774, 0.212553, 0.206425, 0.197683, 0.184448, 0.179695, 0.181177, 0.191995, 0.201095, 0.211438, 0.225075, 0.234821, 0.250945, 0.257556, 0.273586, 0.290611, 0.216450
#*# 	  0.246431, 0.265218, 0.247074, 0.233201, 0.223136, 0.214490, 0.199921, 0.191029, 0.185713, 0.179181, 0.169563, 0.160038, 0.150784, 0.144821, 0.144810, 0.152788, 0.167196, 0.178813, 0.192958, 0.201867, 0.212576, 0.218603, 0.226939, 0.240712, 0.212546
#*# 	  0.184756, 0.238510, 0.218757, 0.205853, 0.194823, 0.183648, 0.172897, 0.162572, 0.153814, 0.143590, 0.137475, 0.122832, 0.111324, 0.108624, 0.108598, 0.117579, 0.119847, 0.130649, 0.138832, 0.152041, 0.159668, 0.169624, 0.176090, 0.189644, 0.171784
#*# 	  0.191331, 0.196656, 0.184022, 0.164714, 0.153437, 0.149532, 0.138126, 0.126946, 0.115279, 0.104584, 0.095228, 0.084269, 0.071462, 0.068250, 0.064729, 0.072601, 0.085272, 0.096110, 0.105241, 0.113184, 0.121615, 0.126197, 0.134318, 0.144796, 0.117477
#*# 	  0.136072, 0.175862, 0.163979, 0.145921, 0.136333, 0.125185, 0.115770, 0.103926, 0.090163, 0.078619, 0.068169, 0.059953, 0.047085, 0.041431, 0.042371, 0.048008, 0.059815, 0.070182, 0.078424, 0.083142, 0.089155, 0.096999, 0.103458, 0.113645, 0.110010
#*# 	  0.130227, 0.159921, 0.144329, 0.129503, 0.117253, 0.106322, 0.094767, 0.083351, 0.074797, 0.062911, 0.053362, 0.043350, 0.030906, 0.027223, 0.026062, 0.030996, 0.042479, 0.051520, 0.058955, 0.068293, 0.075421, 0.081952, 0.090808, 0.099163, 0.084649
#*# 	  0.099943, 0.146711, 0.133863, 0.118153, 0.110023, 0.098350, 0.089406, 0.077314, 0.063209, 0.052063, 0.039480, 0.032276, 0.021050, 0.015719, 0.016144, 0.018271, 0.026176, 0.037737, 0.045272, 0.053907, 0.060345, 0.068092, 0.071541, 0.082001, 0.064907
#*# 	  0.121616, 0.131953, 0.118398, 0.103537, 0.092583, 0.085259, 0.075895, 0.065033, 0.050986, 0.038061, 0.028059, 0.018336, 0.008362, 0.005136, 0.004063, 0.007899, 0.015361, 0.022672, 0.032277, 0.038716, 0.048272, 0.052124, 0.065591, 0.072292, 0.047245
#*# 	  0.086437, 0.120879, 0.108327, 0.095507, 0.085433, 0.073931, 0.062453, 0.052969, 0.035406, 0.028193, 0.014821, 0.005280, -0.003332, -0.010456, -0.008464, -0.005502, 0.004723, 0.012620, 0.021458, 0.025514, 0.034675, 0.039875, 0.046672, 0.056375, 0.051179
#*# 	  0.083614, 0.110815, 0.096096, 0.083378, 0.072772, 0.057323, 0.051173, 0.039201, 0.026963, 0.019154, 0.008432, -0.002759, -0.015463, -0.021473, -0.022029, -0.016086, -0.007698, 0.001454, 0.011299, 0.014811, 0.022367, 0.028072, 0.038666, 0.044378, 0.033817
#*# 	  0.060568, 0.104202, 0.090205, 0.080501, 0.067991, 0.055780, 0.045726, 0.033967, 0.022712, 0.013724, 0.011900, -0.002381, -0.016594, -0.024221, -0.026676, -0.019742, -0.008571, -0.001340, 0.008750, 0.013010, 0.022523, 0.026785, 0.035479, 0.045534, 0.022789
#*# 	  0.092599, 0.101464, 0.087334, 0.076210, 0.069557, 0.057799, 0.049786, 0.040837, 0.031699, 0.022186, 0.016509, -0.001635, -0.014153, -0.021596, -0.025327, -0.021033, -0.009041, 0.001487, 0.010362, 0.014742, 0.022259, 0.028441, 0.035315, 0.044292, 0.022994
#*# 	  0.078042, 0.107664, 0.093045, 0.081636, 0.072511, 0.062309, 0.052847, 0.048259, 0.043235, 0.024733, 0.015045, 0.009451, -0.009385, -0.016722, -0.018784, -0.013896, -0.000959, 0.004287, 0.013995, 0.017094, 0.028556, 0.032386, 0.042857, 0.051674, 0.044127
#*# 	  0.084072, 0.108991, 0.097053, 0.083292, 0.076789, 0.067438, 0.061780, 0.059923, 0.051916, 0.035273, 0.015557, 0.006382, -0.001413, -0.007034, -0.010831, -0.007264, 0.005287, 0.015073, 0.022569, 0.033549, 0.038166, 0.046650, 0.053392, 0.061387, 0.050705
#*# 	  0.081311, 0.119401, 0.104770, 0.089932, 0.081248, 0.081064, 0.073397, 0.061079, 0.048718, 0.033616, 0.024755, 0.014522, 0.005090, 0.000576, -0.000846, 0.005711, 0.014221, 0.019730, 0.032512, 0.037563, 0.049078, 0.055912, 0.067708, 0.075681, 0.052140
#*# 	  0.109191, 0.122023, 0.110774, 0.097539, 0.090162, 0.087595, 0.077853, 0.069267, 0.054470, 0.043472, 0.033919, 0.024291, 0.018553, 0.013163, 0.011587, 0.019567, 0.025925, 0.037762, 0.043657, 0.054920, 0.061198, 0.071988, 0.079282, 0.089550, 0.064590
#*# 	  0.104538, 0.125638, 0.116533, 0.105211, 0.099987, 0.091280, 0.084590, 0.073292, 0.064678, 0.053635, 0.044931, 0.037412, 0.029523, 0.024965, 0.024918, 0.033115, 0.042551, 0.053662, 0.054220, 0.067486, 0.076591, 0.084243, 0.096521, 0.104382, 0.092825
#*# 	  0.115424, 0.131825, 0.123237, 0.114987, 0.104984, 0.099138, 0.088878, 0.081089, 0.076201, 0.066894, 0.059957, 0.051558, 0.044614, 0.040398, 0.041609, 0.050258, 0.060052, 0.071920, 0.078553, 0.086392, 0.098019, 0.105172, 0.118518, 0.128689, 0.115210
#*# 	  0.115348, 0.134778, 0.128209, 0.121633, 0.117451, 0.110097, 0.099578, 0.092935, 0.083624, 0.077057, 0.071678, 0.065388, 0.057204, 0.052878, 0.054679, 0.062785, 0.072725, 0.087408, 0.096918, 0.109422, 0.114624, 0.124592, 0.135372, 0.146406, 0.115258
#*# 	  0.135642, 0.143273, 0.135451, 0.128935, 0.123459, 0.117397, 0.113321, 0.106349, 0.098225, 0.091743, 0.086299, 0.080838, 0.072003, 0.069595, 0.071421, 0.081320, 0.089389, 0.104056, 0.117508, 0.125541, 0.136706, 0.143309, 0.160456, 0.173993, 0.138527
#*# 	  0.139567, 0.153390, 0.146025, 0.140981, 0.137045, 0.130960, 0.125969, 0.119134, 0.112409, 0.106095, 0.100390, 0.094725, 0.089019, 0.086213, 0.088411, 0.098420, 0.113816, 0.127897, 0.136372, 0.146644, 0.153762, 0.162919, 0.179090, 0.191213, 0.172757
#*# 	  0.147570, 0.161210, 0.154360, 0.146096, 0.145796, 0.138006, 0.136183, 0.131687, 0.122694, 0.118626, 0.113231, 0.109821, 0.102842, 0.099470, 0.103062, 0.113493, 0.129153, 0.139631, 0.152668, 0.160124, 0.172015, 0.180975, 0.199037, 0.218303, 0.192296
#*# 	  0.160364, 0.179036, 0.172043, 0.166456, 0.165472, 0.160087, 0.157563, 0.152672, 0.146901, 0.140582, 0.136262, 0.132141, 0.126902, 0.125868, 0.130563, 0.133697, 0.153866, 0.166280, 0.181576, 0.190007, 0.203099, 0.213146, 0.231133, 0.248792, 0.205294
#*# 	  0.182800, 0.190753, 0.184290, 0.177171, 0.179038, 0.175676, 0.173329, 0.171916, 0.164459, 0.158686, 0.155468, 0.153189, 0.148171, 0.146345, 0.152992, 0.163648, 0.180484, 0.189699, 0.208030, 0.215940, 0.232388, 0.241994, 0.264294, 0.286578, 0.235226
#*# 	  0.189284, 0.202291, 0.193027, 0.187613, 0.188479, 0.186759, 0.186803, 0.185839, 0.179573, 0.173727, 0.170890, 0.168224, 0.165121, 0.165425, 0.173720, 0.181061, 0.200682, 0.215513, 0.230209, 0.243111, 0.256619, 0.273342, 0.293932, 0.319136, 0.353826
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 210.0
#*# min_y = 15.0
#*# max_y = 200.0
