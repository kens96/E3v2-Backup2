[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.00122
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 15, 15
#    start point of bed mesh [X, Y]
mesh_max: 210, 200
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 10

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 225
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 120

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345 bed]           #### Uncomment for Y
cs_pin: rpi:None        #### Uncomment for Y

[resonance_tester]      #### Uncomment for Y
accel_chip: adxl345 bed #### Uncomment for Y
probe_points:           #### Uncomment for Y
    112, 112, 20        #### Uncomment for Y

[adxl345 toolhead]      #### Uncomment for X
cs_pin: scanner:PA3     #### Uncomment for X
spi_bus: spi1           #### Uncomment for X

[resonance_tester]      #### Uncomment for X
accel_chip: adxl345 toolhead   #### Uncomment for X
probe_points:           #### Uncomment for X
    112, 112, 20        #### Uncomment for X

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 6000
max_z_velocity: 30
max_z_accel: 400
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 250
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 59.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.061
#*# pid_ki = 2.751
#*# pid_kd = 71.555
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.238
#*# pid_ki = 0.838
#*# pid_kd = 1309.033
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.035
#*#
#*# [scanner model default]
#*# model_coef = 1.491232244621322,
#*# 	1.8512823599319221,
#*# 	0.759789169944979,
#*# 	0.10775960492840443,
#*# 	0.4654680403094783,
#*# 	1.2771829857066193,
#*# 	-0.5124204736358763,
#*# 	-1.6709161433537498,
#*# 	0.44458975589227545,
#*# 	0.8849733341967337
#*# model_domain = 3.160784958828788e-07,3.2922575083350163e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 26.326776
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.345496, 0.322293, 0.304062, 0.290096, 0.281261, 0.269199, 0.259581, 0.248818, 0.239995, 0.236056, 0.227108, 0.219912, 0.215529, 0.209613, 0.208577, 0.219273, 0.231945, 0.245199, 0.260314, 0.272338, 0.282396, 0.296125, 0.308189, 0.321057, 0.246044
#*# 	  0.255669, 0.271932, 0.256726, 0.246080, 0.232857, 0.224381, 0.214439, 0.207275, 0.201850, 0.193145, 0.187513, 0.180229, 0.173424, 0.171033, 0.170567, 0.181185, 0.195324, 0.208094, 0.222404, 0.231210, 0.242270, 0.249433, 0.258193, 0.268844, 0.219816
#*# 	  0.205563, 0.248442, 0.233191, 0.224237, 0.212241, 0.201858, 0.193793, 0.182075, 0.172178, 0.165251, 0.159511, 0.152129, 0.145627, 0.143761, 0.145744, 0.149912, 0.162089, 0.177988, 0.191429, 0.195647, 0.206894, 0.217393, 0.222846, 0.233230, 0.212250
#*# 	  0.177532, 0.210897, 0.196902, 0.187193, 0.172251, 0.162864, 0.154226, 0.143208, 0.132714, 0.126258, 0.123032, 0.112565, 0.104779, 0.102591, 0.101927, 0.109691, 0.124154, 0.137417, 0.147376, 0.153854, 0.165807, 0.173393, 0.178769, 0.187963, 0.163114
#*# 	  0.157941, 0.185427, 0.171541, 0.160407, 0.147130, 0.137106, 0.127206, 0.115750, 0.107499, 0.099946, 0.093130, 0.084201, 0.075902, 0.072779, 0.072259, 0.077179, 0.093151, 0.105958, 0.113334, 0.124033, 0.134460, 0.142547, 0.148915, 0.158952, 0.143213
#*# 	  0.142304, 0.163525, 0.149251, 0.139531, 0.127838, 0.114960, 0.106650, 0.095562, 0.085622, 0.075723, 0.071415, 0.061296, 0.052118, 0.051195, 0.045636, 0.053901, 0.069758, 0.079203, 0.091268, 0.098276, 0.107044, 0.114460, 0.121463, 0.125961, 0.092011
#*# 	  0.105060, 0.149703, 0.139586, 0.125910, 0.110736, 0.101224, 0.091700, 0.077535, 0.065851, 0.059115, 0.046683, 0.043576, 0.034399, 0.032028, 0.031291, 0.034323, 0.042040, 0.058799, 0.068577, 0.072242, 0.082123, 0.090956, 0.095978, 0.100966, 0.083986
#*# 	  0.096434, 0.135150, 0.119727, 0.111665, 0.098867, 0.085708, 0.076078, 0.067592, 0.052349, 0.039835, 0.037779, 0.028004, 0.017223, 0.015596, 0.016051, 0.018180, 0.030589, 0.038230, 0.046218, 0.055153, 0.065264, 0.071067, 0.079474, 0.081545, 0.060903
#*# 	  0.094931, 0.123836, 0.112722, 0.099819, 0.084926, 0.075685, 0.063779, 0.048605, 0.042229, 0.031188, 0.019451, 0.012352, 0.003588, -0.000450, -0.002831, 0.003889, 0.013730, 0.024485, 0.031932, 0.037013, 0.046990, 0.053007, 0.059176, 0.064878, 0.056844
#*# 	  0.086712, 0.110039, 0.099964, 0.087309, 0.078048, 0.065116, 0.051222, 0.044596, 0.035862, 0.025214, 0.014596, 0.004375, -0.007205, -0.010584, -0.014329, -0.006237, 0.005872, 0.012406, 0.020626, 0.031404, 0.038999, 0.044385, 0.053526, 0.057195, 0.028783
#*# 	  0.063184, 0.104613, 0.095456, 0.082487, 0.068581, 0.060073, 0.048188, 0.034872, 0.027919, 0.023619, 0.010558, 0.002558, -0.008959, -0.018274, -0.017988, -0.012167, -0.003175, 0.007149, 0.014682, 0.022559, 0.031365, 0.037947, 0.045931, 0.054178, 0.031789
#*# 	  0.069829, 0.104687, 0.093228, 0.081418, 0.071794, 0.061152, 0.048531, 0.041535, 0.037743, 0.023019, 0.020303, 0.000772, -0.008694, -0.015383, -0.017833, -0.009095, 0.000171, 0.005732, 0.016045, 0.024646, 0.031187, 0.039623, 0.050330, 0.056452, 0.031133
#*# 	  0.081864, 0.111854, 0.097628, 0.084399, 0.075241, 0.066262, 0.055753, 0.046380, 0.046308, 0.030372, 0.015136, 0.011865, -0.000439, -0.010928, -0.014027, -0.006977, 0.004209, 0.012219, 0.019965, 0.028058, 0.035915, 0.044394, 0.054791, 0.059443, 0.048142
#*# 	  0.083003, 0.109560, 0.096753, 0.084296, 0.074984, 0.066855, 0.059568, 0.056530, 0.051265, 0.033726, 0.012637, 0.005383, -0.004327, -0.009004, -0.014748, -0.005726, 0.006492, 0.007399, 0.019930, 0.030129, 0.037719, 0.045479, 0.054657, 0.058100, 0.028909
#*# 	  0.080624, 0.116509, 0.102838, 0.090989, 0.079598, 0.080422, 0.071014, 0.057239, 0.044188, 0.032214, 0.017645, 0.010421, 0.004648, -0.001535, -0.004970, 0.002487, 0.010681, 0.017164, 0.026904, 0.036005, 0.041344, 0.051113, 0.057899, 0.063611, 0.044470
#*# 	  0.086242, 0.119164, 0.108836, 0.097977, 0.086476, 0.083486, 0.070401, 0.059091, 0.049113, 0.038624, 0.026019, 0.020416, 0.013240, 0.006815, 0.007850, 0.015387, 0.023594, 0.027006, 0.037817, 0.047462, 0.056309, 0.065673, 0.073894, 0.077596, 0.057207
#*# 	  0.100870, 0.123901, 0.113349, 0.102349, 0.095698, 0.088310, 0.075997, 0.064140, 0.059086, 0.048173, 0.036365, 0.030163, 0.026041, 0.018425, 0.016633, 0.024325, 0.035695, 0.044084, 0.050541, 0.060238, 0.069765, 0.077536, 0.087572, 0.091590, 0.079800
#*# 	  0.106284, 0.124008, 0.118702, 0.110745, 0.101778, 0.094124, 0.083382, 0.071677, 0.066650, 0.056740, 0.046304, 0.039515, 0.034306, 0.026108, 0.026187, 0.034583, 0.044375, 0.053147, 0.062347, 0.071728, 0.084149, 0.089304, 0.098558, 0.104388, 0.075551
#*# 	  0.107187, 0.130876, 0.125021, 0.118354, 0.113715, 0.104520, 0.094374, 0.085129, 0.077084, 0.069267, 0.060074, 0.054131, 0.048229, 0.042927, 0.039380, 0.050374, 0.059281, 0.065887, 0.076294, 0.088099, 0.097475, 0.105904, 0.115141, 0.120573, 0.102282
#*# 	  0.114628, 0.137392, 0.131255, 0.125112, 0.114820, 0.109711, 0.102020, 0.091983, 0.082598, 0.079533, 0.067546, 0.065222, 0.057588, 0.051548, 0.053497, 0.061622, 0.073991, 0.085220, 0.095133, 0.103000, 0.114272, 0.120176, 0.129566, 0.136212, 0.114431
#*# 	  0.131174, 0.142982, 0.138106, 0.131047, 0.126990, 0.119469, 0.111991, 0.105734, 0.099444, 0.091287, 0.085575, 0.078402, 0.071841, 0.067875, 0.065415, 0.075868, 0.091414, 0.103105, 0.109393, 0.118776, 0.126699, 0.136481, 0.147336, 0.156181, 0.140884
#*# 	  0.138241, 0.151783, 0.146238, 0.142588, 0.134081, 0.128332, 0.122898, 0.115266, 0.109103, 0.104175, 0.097059, 0.090839, 0.083695, 0.080863, 0.079380, 0.091224, 0.103434, 0.116624, 0.126243, 0.133551, 0.144920, 0.154144, 0.163702, 0.175793, 0.137515
#*# 	  0.148503, 0.162210, 0.157142, 0.152867, 0.147829, 0.142872, 0.138777, 0.131967, 0.126206, 0.120001, 0.116158, 0.111559, 0.105219, 0.102012, 0.102042, 0.112933, 0.127514, 0.138788, 0.151365, 0.160624, 0.170036, 0.181747, 0.192362, 0.204581, 0.169127
#*# 	  0.161483, 0.175070, 0.168902, 0.165857, 0.161858, 0.155563, 0.154551, 0.150481, 0.141297, 0.137529, 0.132205, 0.128408, 0.122878, 0.121178, 0.123901, 0.133232, 0.149099, 0.160583, 0.172813, 0.182124, 0.194568, 0.205955, 0.217807, 0.232873, 0.195879
#*# 	  0.178102, 0.187808, 0.180310, 0.177533, 0.173213, 0.170030, 0.167807, 0.166804, 0.159288, 0.153467, 0.150404, 0.144823, 0.140340, 0.139935, 0.139363, 0.152138, 0.167288, 0.180646, 0.193559, 0.202188, 0.216486, 0.231225, 0.244103, 0.262390, 0.298383
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 210.0
#*# min_y = 15.0
#*# max_y = 200.0
