[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01204
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 15, 15
#    start point of bed mesh [X, Y]
mesh_max: 210, 200
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 10

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 225
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 120

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345 bed]           #### Uncomment for Y
cs_pin: rpi:None        #### Uncomment for Y

[resonance_tester]      #### Uncomment for Y
accel_chip: adxl345 bed #### Uncomment for Y
probe_points:           #### Uncomment for Y
    112, 112, 20        #### Uncomment for Y

[adxl345 toolhead]      #### Uncomment for X
cs_pin: scanner:PA3     #### Uncomment for X
spi_bus: spi1           #### Uncomment for X

[resonance_tester]      #### Uncomment for X
accel_chip: adxl345 toolhead   #### Uncomment for X
probe_points:           #### Uncomment for X
    112, 112, 20        #### Uncomment for X

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 6000
max_z_velocity: 30
max_z_accel: 400
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 250
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 54.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 42.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.061
#*# pid_ki = 2.751
#*# pid_kd = 71.555
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.238
#*# pid_ki = 0.838
#*# pid_kd = 1309.033
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.5051225983378953,
#*# 	1.8195102390006643,
#*# 	0.7021231371548109,
#*# 	0.5179341351214521,
#*# 	0.4514142856553639,
#*# 	-0.08515172425706082,
#*# 	-0.27110137461058453,
#*# 	0.12857188619028087,
#*# 	0.2608578490457167,
#*# 	0.06999231648430079
#*# model_domain = 3.1657411074412126e-07,3.292824091111193e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 23.534723
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.300148, 0.276638, 0.261987, 0.253412, 0.245887, 0.239910, 0.235641, 0.228173, 0.221372, 0.216840, 0.213569, 0.207620, 0.201779, 0.199977, 0.203303, 0.215280, 0.230727, 0.244330, 0.257065, 0.270825, 0.280751, 0.291640, 0.303427, 0.317308, 0.332977
#*# 	  0.253047, 0.239586, 0.225087, 0.216281, 0.211347, 0.204334, 0.196263, 0.191778, 0.183870, 0.178897, 0.174962, 0.169429, 0.161350, 0.159143, 0.160252, 0.173539, 0.186667, 0.199801, 0.212996, 0.224787, 0.233822, 0.241024, 0.249966, 0.261229, 0.276911
#*# 	  0.225762, 0.214872, 0.204312, 0.195043, 0.187462, 0.181522, 0.173846, 0.167588, 0.160112, 0.154543, 0.151501, 0.144153, 0.137850, 0.135562, 0.136813, 0.148227, 0.160260, 0.173565, 0.186242, 0.195729, 0.205094, 0.209075, 0.216640, 0.228388, 0.242626
#*# 	  0.188878, 0.178439, 0.168038, 0.157010, 0.148120, 0.142478, 0.133960, 0.125148, 0.117719, 0.109791, 0.103609, 0.094613, 0.087640, 0.082087, 0.083147, 0.092353, 0.102961, 0.114420, 0.125329, 0.133380, 0.139498, 0.145623, 0.150288, 0.159653, 0.169889
#*# 	  0.168243, 0.161555, 0.153501, 0.140949, 0.133174, 0.125521, 0.116828, 0.109441, 0.100774, 0.093567, 0.086865, 0.076853, 0.068561, 0.064375, 0.063387, 0.072538, 0.083269, 0.092875, 0.102938, 0.110327, 0.115695, 0.122140, 0.127733, 0.135014, 0.144785
#*# 	  0.144929, 0.136448, 0.126960, 0.114438, 0.106580, 0.099010, 0.089157, 0.078676, 0.067867, 0.058577, 0.052705, 0.042515, 0.032289, 0.026563, 0.023960, 0.029811, 0.039584, 0.049289, 0.056731, 0.062425, 0.067390, 0.070789, 0.075356, 0.079666, 0.086355
#*# 	  0.134303, 0.127933, 0.118686, 0.105967, 0.096378, 0.087316, 0.078664, 0.070740, 0.060152, 0.048281, 0.042145, 0.032315, 0.022735, 0.015549, 0.011271, 0.017035, 0.026682, 0.034348, 0.040759, 0.045358, 0.049653, 0.054307, 0.058484, 0.062463, 0.064160
#*# 	  0.124646, 0.116458, 0.108203, 0.096840, 0.086082, 0.079189, 0.069612, 0.060780, 0.049305, 0.037085, 0.030276, 0.021307, 0.010867, 0.004597, 0.001348, 0.004314, 0.013330, 0.018933, 0.026057, 0.030650, 0.035569, 0.039779, 0.042651, 0.046889, 0.047758
#*# 	  0.115174, 0.105782, 0.098634, 0.086346, 0.076908, 0.069887, 0.060734, 0.050836, 0.038694, 0.026861, 0.018417, 0.008460, -0.000731, -0.006256, -0.009002, -0.004692, -0.001291, 0.006564, 0.012756, 0.016543, 0.021379, 0.024423, 0.027770, 0.028714, 0.029958
#*# 	  0.108591, 0.099276, 0.096299, 0.083214, 0.073421, 0.065921, 0.054613, 0.045336, 0.034259, 0.021491, 0.013042, 0.002941, -0.008179, -0.014581, -0.018787, -0.012375, -0.008914, -0.000632, 0.003982, 0.007529, 0.011306, 0.014269, 0.017317, 0.019871, 0.021093
#*# 	  0.106859, 0.098384, 0.090939, 0.078623, 0.070729, 0.063825, 0.052438, 0.043041, 0.030272, 0.018372, 0.008781, -0.002543, -0.012597, -0.021051, -0.024337, -0.020129, -0.014603, -0.008535, -0.003842, -0.000494, 0.002427, 0.004340, 0.006969, 0.009479, 0.007564
#*# 	  0.104605, 0.098654, 0.093060, 0.080600, 0.071573, 0.064022, 0.052790, 0.044527, 0.032813, 0.020079, 0.010512, 0.000264, -0.011000, -0.018415, -0.025388, -0.020568, -0.013864, -0.007356, -0.001762, 0.000975, 0.003419, 0.006926, 0.009865, 0.009148, 0.009296
#*# 	  0.110565, 0.105376, 0.096764, 0.085000, 0.077718, 0.069619, 0.059552, 0.050333, 0.037654, 0.026254, 0.014981, 0.003616, -0.007903, -0.015294, -0.020879, -0.018426, -0.012081, -0.006278, -0.000679, 0.004210, 0.005892, 0.009157, 0.009235, 0.008604, 0.005795
#*# 	  0.115782, 0.105826, 0.097947, 0.085637, 0.078393, 0.071228, 0.060474, 0.052676, 0.040320, 0.029615, 0.018186, 0.007416, -0.002061, -0.010836, -0.016531, -0.011107, -0.006353, -0.001106, 0.004809, 0.008713, 0.012804, 0.015048, 0.016673, 0.016485, 0.016183
#*# 	  0.117193, 0.108291, 0.098045, 0.086998, 0.080263, 0.074814, 0.063962, 0.055885, 0.044702, 0.033045, 0.023665, 0.011312, 0.001717, -0.005066, -0.011002, -0.006739, -0.000730, 0.005056, 0.010112, 0.012537, 0.015647, 0.019179, 0.021584, 0.023041, 0.023978
#*# 	  0.115096, 0.107732, 0.099933, 0.090841, 0.085046, 0.079380, 0.069699, 0.059829, 0.050454, 0.039804, 0.030360, 0.020430, 0.010101, 0.002076, -0.000155, 0.001792, 0.008813, 0.014867, 0.021166, 0.024094, 0.027536, 0.032572, 0.035662, 0.039115, 0.038992
#*# 	  0.110232, 0.106273, 0.102289, 0.094919, 0.089061, 0.082957, 0.073188, 0.066410, 0.054826, 0.046154, 0.036646, 0.026476, 0.018583, 0.010643, 0.005619, 0.009891, 0.016742, 0.024922, 0.028943, 0.032218, 0.035839, 0.041818, 0.045214, 0.049437, 0.052128
#*# 	  0.101914, 0.099832, 0.100003, 0.092094, 0.085810, 0.080899, 0.072542, 0.064627, 0.055475, 0.043899, 0.035584, 0.026202, 0.018213, 0.010420, 0.005940, 0.011647, 0.016970, 0.024977, 0.031321, 0.034622, 0.039690, 0.044329, 0.048293, 0.053793, 0.055070
#*# 	  0.110707, 0.108547, 0.108540, 0.101255, 0.098308, 0.091822, 0.083751, 0.076720, 0.067586, 0.056282, 0.050256, 0.040776, 0.030802, 0.026273, 0.021591, 0.026663, 0.034278, 0.040888, 0.047610, 0.052224, 0.056810, 0.060919, 0.067195, 0.072193, 0.077812
#*# 	  0.107392, 0.104467, 0.103347, 0.098660, 0.095299, 0.090608, 0.084048, 0.075594, 0.066845, 0.058308, 0.051231, 0.041730, 0.032311, 0.025857, 0.024498, 0.029279, 0.036965, 0.045914, 0.053510, 0.056354, 0.061154, 0.065558, 0.071914, 0.079322, 0.085855
#*# 	  0.112389, 0.112463, 0.112735, 0.106551, 0.101957, 0.100442, 0.094535, 0.087817, 0.081137, 0.072380, 0.065091, 0.055958, 0.046237, 0.041174, 0.038408, 0.046552, 0.054834, 0.062252, 0.068782, 0.073735, 0.077641, 0.085549, 0.092950, 0.102359, 0.112711
#*# 	  0.124589, 0.124058, 0.123067, 0.119707, 0.116582, 0.111828, 0.107014, 0.100944, 0.093776, 0.085281, 0.080850, 0.071987, 0.063021, 0.058611, 0.056623, 0.063463, 0.074176, 0.083479, 0.091058, 0.095074, 0.099008, 0.107379, 0.115780, 0.127322, 0.136816
#*# 	  0.136216, 0.134975, 0.136498, 0.130891, 0.128553, 0.125947, 0.122887, 0.117743, 0.109827, 0.101282, 0.097307, 0.087838, 0.079921, 0.076200, 0.074201, 0.082382, 0.092909, 0.102113, 0.108571, 0.114772, 0.120847, 0.129560, 0.141119, 0.154703, 0.166871
#*# 	  0.144850, 0.141079, 0.142172, 0.134719, 0.133662, 0.132967, 0.129170, 0.125687, 0.118351, 0.110344, 0.103714, 0.096502, 0.089492, 0.085138, 0.085051, 0.093588, 0.104433, 0.112193, 0.121522, 0.127328, 0.134904, 0.145168, 0.158049, 0.171879, 0.186506
#*# 	  0.162798, 0.158567, 0.157389, 0.151156, 0.150828, 0.149548, 0.145875, 0.142899, 0.136367, 0.128030, 0.122345, 0.114913, 0.107266, 0.106220, 0.105085, 0.112589, 0.124323, 0.134034, 0.142786, 0.150043, 0.158797, 0.170834, 0.185794, 0.202735, 0.223888
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 210.0
#*# min_y = 15.0
#*# max_y = 200.0
