[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.00122
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 15, 15
#    start point of bed mesh [X, Y]
mesh_max: 210, 200
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 10

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 225
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 120

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345 bed]           #### Uncomment for Y
cs_pin: rpi:None        #### Uncomment for Y

[resonance_tester]      #### Uncomment for Y
accel_chip: adxl345 bed #### Uncomment for Y
probe_points:           #### Uncomment for Y
    112, 112, 20        #### Uncomment for Y

[adxl345 toolhead]      #### Uncomment for X
cs_pin: scanner:PA3     #### Uncomment for X
spi_bus: spi1           #### Uncomment for X

[resonance_tester]      #### Uncomment for X
accel_chip: adxl345 toolhead   #### Uncomment for X
probe_points:           #### Uncomment for X
    112, 112, 20        #### Uncomment for X

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 6000
max_z_velocity: 30
max_z_accel: 400
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 250
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 54.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 42.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.061
#*# pid_ki = 2.751
#*# pid_kd = 71.555
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.238
#*# pid_ki = 0.838
#*# pid_kd = 1309.033
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.491232244621322,
#*# 	  1.8512823599319221,
#*# 	  0.759789169944979,
#*# 	  0.10775960492840443,
#*# 	  0.4654680403094783,
#*# 	  1.2771829857066193,
#*# 	  -0.5124204736358763,
#*# 	  -1.6709161433537498,
#*# 	  0.44458975589227545,
#*# 	  0.8849733341967337
#*# model_domain = 3.160784958828788e-07,3.2922575083350163e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 26.326776
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.318295, 0.293547, 0.276678, 0.263965, 0.253189, 0.243567, 0.235598, 0.225725, 0.218699, 0.212579, 0.208139, 0.202480, 0.194879, 0.192628, 0.195381, 0.207255, 0.221542, 0.236735, 0.248089, 0.260170, 0.272239, 0.282016, 0.294477, 0.307505, 0.325241
#*# 	  0.284372, 0.261254, 0.245732, 0.231848, 0.223863, 0.215082, 0.204719, 0.198131, 0.189504, 0.183029, 0.179269, 0.172901, 0.166094, 0.162742, 0.164509, 0.176298, 0.188390, 0.202633, 0.215268, 0.227856, 0.237145, 0.242942, 0.250470, 0.264399, 0.279642
#*# 	  0.249749, 0.229478, 0.212663, 0.197399, 0.187437, 0.180162, 0.167397, 0.159334, 0.150402, 0.141952, 0.136828, 0.127230, 0.120008, 0.116331, 0.114407, 0.126094, 0.137271, 0.149644, 0.160782, 0.168376, 0.177030, 0.181526, 0.187286, 0.195734, 0.208951
#*# 	  0.218517, 0.202965, 0.188080, 0.170721, 0.160974, 0.152403, 0.140843, 0.131927, 0.123350, 0.113586, 0.107947, 0.099005, 0.091495, 0.084894, 0.085495, 0.095594, 0.106113, 0.117838, 0.128271, 0.135376, 0.143246, 0.147171, 0.152787, 0.163178, 0.171107
#*# 	  0.187483, 0.172622, 0.160067, 0.143083, 0.130747, 0.120751, 0.108339, 0.099425, 0.087523, 0.077787, 0.071376, 0.060431, 0.050017, 0.044141, 0.040829, 0.049260, 0.058601, 0.069789, 0.077344, 0.084232, 0.089139, 0.092941, 0.097849, 0.105982, 0.110369
#*# 	  0.171256, 0.155644, 0.142302, 0.126477, 0.113586, 0.104996, 0.091360, 0.081957, 0.070203, 0.058482, 0.050356, 0.040209, 0.030224, 0.022405, 0.018975, 0.026155, 0.035736, 0.044494, 0.052748, 0.057260, 0.062111, 0.064675, 0.070197, 0.074070, 0.078960
#*# 	  0.161580, 0.145685, 0.133867, 0.117807, 0.104616, 0.095511, 0.083236, 0.071775, 0.059784, 0.048012, 0.040054, 0.029750, 0.018771, 0.012474, 0.007950, 0.013141, 0.019478, 0.029168, 0.035306, 0.039576, 0.044415, 0.047826, 0.051817, 0.055468, 0.056727
#*# 	  0.150570, 0.134814, 0.121847, 0.107003, 0.094552, 0.084166, 0.072150, 0.061231, 0.050130, 0.037694, 0.030220, 0.019675, 0.009778, 0.003790, 0.001026, 0.005041, 0.010590, 0.020118, 0.026256, 0.029495, 0.034628, 0.038263, 0.041947, 0.045092, 0.047076
#*# 	  0.142799, 0.124947, 0.114487, 0.098022, 0.084918, 0.075174, 0.063340, 0.051907, 0.039853, 0.027371, 0.018062, 0.005994, -0.002401, -0.010149, -0.014478, -0.009476, -0.004051, 0.002259, 0.007780, 0.011011, 0.016396, 0.019133, 0.021369, 0.023957, 0.022839
#*# 	  0.135335, 0.122258, 0.108098, 0.093113, 0.081009, 0.070291, 0.058566, 0.046131, 0.033298, 0.020007, 0.010485, -0.000354, -0.011674, -0.019183, -0.023171, -0.018667, -0.014432, -0.007082, -0.001582, 0.000890, 0.004490, 0.007003, 0.009496, 0.012510, 0.011908
#*# 	  0.130098, 0.117591, 0.104935, 0.090659, 0.078439, 0.066191, 0.055743, 0.044047, 0.031015, 0.018191, 0.007286, -0.005154, -0.015881, -0.023399, -0.029129, -0.025008, -0.019037, -0.011464, -0.007688, -0.004734, -0.002323, 0.001272, 0.003068, 0.005726, 0.003979
#*# 	  0.130964, 0.118665, 0.106132, 0.091684, 0.079952, 0.067711, 0.054994, 0.045877, 0.032390, 0.017954, 0.007717, -0.006384, -0.016683, -0.023719, -0.031449, -0.028731, -0.021906, -0.016757, -0.011700, -0.008134, -0.005497, -0.003820, -0.001867, -0.001962, -0.005713
#*# 	  0.140294, 0.125415, 0.109716, 0.097893, 0.085140, 0.076606, 0.062632, 0.049409, 0.037807, 0.023243, 0.013073, 0.000550, -0.012480, -0.020059, -0.025886, -0.023264, -0.019930, -0.013647, -0.007069, -0.004905, -0.001875, -0.001110, -0.000803, 0.000967, -0.004002
#*# 	  0.141491, 0.125218, 0.110731, 0.096215, 0.086384, 0.075914, 0.064017, 0.052791, 0.040295, 0.026885, 0.016579, 0.004193, -0.006923, -0.015429, -0.021372, -0.017189, -0.013530, -0.007116, -0.002559, 0.001605, 0.006521, 0.006740, 0.008660, 0.009648, 0.007318
#*# 	  0.144153, 0.127894, 0.111125, 0.098060, 0.086702, 0.079496, 0.067640, 0.056767, 0.043727, 0.031663, 0.021283, 0.008331, -0.001100, -0.010836, -0.017349, -0.010804, -0.007790, -0.000866, 0.003068, 0.006467, 0.010179, 0.012342, 0.014973, 0.017407, 0.016970
#*# 	  0.141436, 0.126216, 0.113230, 0.101837, 0.093304, 0.083927, 0.074096, 0.062447, 0.050564, 0.037872, 0.028077, 0.017136, 0.006956, -0.000856, -0.006135, -0.002425, 0.003130, 0.010079, 0.015214, 0.017904, 0.021064, 0.025072, 0.029103, 0.032180, 0.031239
#*# 	  0.135409, 0.124818, 0.115574, 0.105127, 0.095591, 0.088814, 0.077868, 0.066910, 0.054414, 0.042899, 0.034086, 0.022730, 0.013405, 0.005823, -0.000829, 0.004342, 0.009955, 0.016885, 0.021863, 0.024792, 0.029715, 0.033706, 0.037917, 0.041655, 0.042243
#*# 	  0.132471, 0.121167, 0.112197, 0.103115, 0.095680, 0.087729, 0.076256, 0.065932, 0.054340, 0.043806, 0.034754, 0.023215, 0.014586, 0.006916, 0.001618, 0.006136, 0.013662, 0.020312, 0.025670, 0.027821, 0.032036, 0.035925, 0.041017, 0.045526, 0.045170
#*# 	  0.136706, 0.127043, 0.121433, 0.110935, 0.104055, 0.096851, 0.086740, 0.077210, 0.066997, 0.055259, 0.046413, 0.037314, 0.026353, 0.021222, 0.016197, 0.020495, 0.029341, 0.035510, 0.041651, 0.045114, 0.048342, 0.053806, 0.059059, 0.064546, 0.068170
#*# 	  0.135004, 0.126614, 0.121079, 0.110519, 0.103643, 0.098721, 0.088235, 0.079173, 0.070723, 0.059915, 0.051195, 0.041248, 0.030532, 0.023475, 0.021027, 0.028013, 0.034822, 0.041911, 0.047543, 0.051296, 0.055199, 0.060291, 0.066380, 0.073679, 0.078650
#*# 	  0.144621, 0.137549, 0.130665, 0.120616, 0.114379, 0.109202, 0.100012, 0.093474, 0.083643, 0.073957, 0.066651, 0.055478, 0.045932, 0.040252, 0.036303, 0.043033, 0.052698, 0.061327, 0.066388, 0.068998, 0.073839, 0.078806, 0.087475, 0.096522, 0.103436
#*# 	  0.150473, 0.143588, 0.138803, 0.129841, 0.123549, 0.119226, 0.111459, 0.105629, 0.095811, 0.085170, 0.079026, 0.069889, 0.059963, 0.054973, 0.052777, 0.058887, 0.067221, 0.077283, 0.083578, 0.087793, 0.093273, 0.100606, 0.109286, 0.120040, 0.128226
#*# 	  0.160247, 0.151640, 0.147082, 0.138723, 0.133930, 0.129886, 0.123069, 0.115650, 0.107312, 0.096691, 0.092293, 0.082698, 0.075101, 0.070300, 0.068976, 0.076465, 0.085917, 0.094701, 0.102200, 0.105834, 0.112381, 0.119595, 0.132419, 0.143686, 0.155828
#*# 	  0.175008, 0.166115, 0.160600, 0.150785, 0.146487, 0.142657, 0.138469, 0.132527, 0.125054, 0.114180, 0.107804, 0.099263, 0.091935, 0.087589, 0.084350, 0.094233, 0.102972, 0.110997, 0.118898, 0.125748, 0.132897, 0.142616, 0.153810, 0.168895, 0.181809
#*# 	  0.187866, 0.178505, 0.169517, 0.159667, 0.157283, 0.154367, 0.149681, 0.143405, 0.135646, 0.126853, 0.119934, 0.112124, 0.104267, 0.100346, 0.100579, 0.108738, 0.118348, 0.128687, 0.136223, 0.143570, 0.151220, 0.161492, 0.177099, 0.194118, 0.214067
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 210.0
#*# min_y = 15.0
#*# max_y = 200.0
